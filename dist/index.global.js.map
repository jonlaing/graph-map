{"version":3,"sources":["../src/PropSet.ts","../src/PropValueMap.ts","../src/Value.ts","../src/GraphMap.ts","../src/index.ts"],"sourcesContent":["import Value from \"./Value\";\n\nexport default class PropSet<T extends object> {\n  private data: Set<Value<T>> = new Set();\n\n  get size() {\n    return this.data.size;\n  }\n\n  first(): Value<T> | undefined {\n    for (const val of this.data) {\n      return val;\n    }\n  }\n\n  add(val: Value<T>) {\n    this.data.add(val);\n  }\n\n  remove(val: Value<T>, markRemoved = true) {\n    this.data.delete(val) && markRemoved && val.markRemoved();\n  }\n\n  clear() {\n    for (const val of this.values) {\n      this.remove(val);\n    }\n  }\n\n  get values() {\n    return this.data;\n  }\n\n  toArray(): T[] {\n    const arr: T[] = [];\n    for (const val of this.values) {\n      arr.push(val.value);\n    }\n    return arr;\n  }\n}\n","import PropSet from \"./PropSet\";\nimport Value from \"./Value\";\n\nexport default class PropValueMap<T extends object> {\n  key: keyof T;\n  private props: Map<T[keyof T], PropSet<T>> = new Map();\n\n  constructor(key: keyof T) {\n    this.key = key;\n  }\n\n  has(propVal: T[keyof T]): boolean {\n    return this.props.has(propVal);\n  }\n\n  getAll(propVal: T[keyof T]): PropSet<T> | undefined {\n    return this.props.get(propVal);\n  }\n\n  getFirst(propVal: T[keyof T]): Value<T> | undefined {\n    return this.getAll(propVal)?.first();\n  }\n\n  getFirstValue(propVal: T[keyof T]): T | undefined {\n    return this.getFirst(propVal)?.value;\n  }\n\n  add(val: Value<T>) {\n    const propVal = val.value[this.key];\n    if (this.props.has(propVal)) {\n      this.props.get(propVal)?.add(val);\n    } else {\n      const props = new PropSet<T>();\n      props.add(val);\n      this.props.set(propVal, props);\n    }\n  }\n\n  remove(propVal: T[keyof T]) {\n    this.props.get(propVal)?.clear();\n    this.props.delete(propVal);\n  }\n\n  removeValue(val: Value<T>, prop?: T[keyof T], markRemoved = true) {\n    const propVal = prop ?? val.value[this.key];\n\n    this.props.get(propVal)?.remove(val, markRemoved);\n\n    if (this.props.get(propVal)?.size === 0) {\n      this.props.delete(propVal);\n    }\n  }\n\n  entries() {\n    return this.props.entries();\n  }\n\n  toRecord(): Record<string, T[]> {\n    const obj: Record<string, T[]> = {};\n\n    for (const [key, val] of this.props) {\n      obj[`${key}`] = val.toArray();\n    }\n\n    return obj;\n  }\n}\n","type CallbackSet<T> = Set<(val: T) => void>;\n\nexport default class Value<T extends object> {\n  value: T;\n  private listeners: Map<keyof T, CallbackSet<T>> = new Map();\n\n  constructor(val: T) {\n    this.value = val;\n  }\n\n  private onChange(key: keyof T) {\n    if (this.listeners.has(key)) {\n      for (const callback of this.listeners.get(key) as CallbackSet<T>) {\n        callback(this.value);\n      }\n    }\n  }\n\n  addKeyListener(key: keyof T, callback: (val: T) => void): () => void {\n    if (this.listeners.has(key)) {\n      this.listeners.get(key)?.add(callback);\n    } else {\n      this.listeners.set(key, new Set([callback]));\n    }\n\n    return () => this.listeners.get(key)?.delete(callback);\n  }\n\n  update(f: (val: T) => NonNullable<T>): void {\n    const newVal = f({ ...this.value }) as T;\n    for (const k in newVal) {\n      if (this.value[k] !== newVal[k]) {\n        this.value[k] = newVal[k];\n        this.onChange(k);\n      }\n    }\n  }\n\n  set(val: NonNullable<T>): void {\n    this.update(() => val);\n  }\n\n  clone(): T {\n    return { ...this.value };\n  }\n\n  markRemoved() {\n    for (const set of this.listeners.values()) {\n      for (const cb of set) {\n        cb({} as T);\n      }\n    }\n  }\n}\n","import PropSet from \"./PropSet\";\nimport PropValueMap from \"./PropValueMap\";\nimport Value from \"./Value\";\n\nexport default class GraphMap<T extends object> {\n  private data: Map<keyof T, PropValueMap<T>> = new Map();\n\n  constructor(indices: (keyof T)[], values: T[]) {\n    indices.forEach((key) => this.data.set(key, new PropValueMap<T>(key)));\n    this.concat(values);\n  }\n\n  keys() {\n    return this.data.keys();\n  }\n\n  hasKey(key: keyof T): boolean {\n    return this.data.has(key);\n  }\n\n  concat(vals: T[]): void {\n    vals.forEach((val) => {\n      const nodeValue = new Value({ ...val });\n\n      for (const [key, nodeKey] of this.data.entries()) {\n        nodeValue.addKeyListener(key, (newVal) => {\n          if (!newVal[key]) {\n            this.data.get(key)?.removeValue(nodeValue, val[key], false);\n            return;\n          }\n\n          if (newVal[key] !== val[key]) {\n            this.data.get(key)?.removeValue(nodeValue, val[key], false);\n            this.data.get(key)?.add(nodeValue);\n          }\n        });\n\n        nodeKey.add(nodeValue);\n      }\n    });\n  }\n\n  append(val: T): void {\n    this.concat([val]);\n  }\n\n  getByPropValue(key: keyof T, value: T[keyof T]): PropSet<T> | undefined {\n    return this.data.get(key)?.getAll(value);\n  }\n\n  groupBy(key: keyof T): PropValueMap<T> | undefined {\n    return this.data.get(key);\n  }\n\n  update(key: keyof T, value: T[keyof T], f: (val: T) => NonNullable<T>): void {\n    const set = this.data.get(key)?.getAll(value)?.values;\n\n    if (!set) return;\n\n    for (const node of set) {\n      node.update(f);\n    }\n  }\n\n  updateMany(\n    key: keyof T,\n    values: T[keyof T][],\n    f: (val: T) => NonNullable<T>\n  ): void {\n    if (!this.data.has(key)) return;\n\n    const map = this.data.get(key) as PropValueMap<T>;\n\n    for (const [val, set] of map.entries()) {\n      if (values.includes(val)) {\n        for (const node of set.values) {\n          node.update(f);\n        }\n      }\n    }\n  }\n\n  set(key: keyof T, value: T[keyof T], val: T): void {\n    this.update(key, value, () => val as NonNullable<T>);\n  }\n\n  remove(key: keyof T, value: T[keyof T]): void {\n    this.data.get(key)?.remove(value);\n  }\n\n  toRecord(): Record<string, Record<string, T[]>> {\n    const obj: Record<string, Record<string, T[]>> = {};\n    for (const [key, val] of this.data) {\n      obj[String(key)] = val.toRecord();\n    }\n    return obj;\n  }\n}\n","import GraphMap from \"./GraphMap\";\n\nexport default GraphMap;\n"],"mappings":"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","names":["_a"]}